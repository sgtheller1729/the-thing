<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Simulator Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #log {
            max-height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .entry {
            margin-bottom: 5px;
        }

        .device {
            font-weight: bold;
        }

        .payload {
            color: blue;
        }
    </style>
</head>

<body>
    <h1>MQTT Simulator Dashboard</h1>
    <div id="log">Loading activity...</div>

    <script>
        const logContainer = document.getElementById('log');

        // Function to update the dashboard with activity data
        function updateLog(data) {
            logContainer.innerHTML = ''; // Clear previous entries

            // Define the word map for action words only
            const wordMap = {
                positive: ["On", "Unlock", "Increase", "Start"],
                negative: ["Off", "Lock", "Decrease", "Stop"],
                neutral: []
            };

            Object.keys(data).forEach(device => {
                const entry = document.createElement('div');
                entry.className = 'entry';

                const deviceSpan = document.createElement('span');
                deviceSpan.className = 'device';
                deviceSpan.textContent = `Device: ${device}`;

                const payloadSpan = document.createElement('span');
                payloadSpan.className = 'payload';

                // Highlight action words in the payload
                const payloadText = data[device];
                const highlightedText = payloadText.split(' ').map(word => {
                    if (wordMap.positive.includes(word)) {
                        return `<span style="color: green; font-weight: bold;">${word}</span>`;
                    } else if (wordMap.negative.includes(word)) {
                        return `<span style="color: red; font-weight: bold;">${word}</span>`;
                    } else {
                        // Leave other words uncolored
                        return word;
                    }
                }).join(' ');

                payloadSpan.innerHTML = ` - Last Response: ${highlightedText}`;

                entry.appendChild(deviceSpan);
                entry.appendChild(payloadSpan);
                logContainer.appendChild(entry);
            });
        }

        // Fetch initial activity from the /activity endpoint
        async function fetchActivity() {
            try {
                const response = await fetch('/activity');
                if (response.ok) {
                    const data = await response.json();
                    updateLog(data);
                } else {
                    logContainer.textContent = 'Error fetching initial activity.';
                }
            } catch (err) {
                console.error('Error fetching activity:', err);
                logContainer.textContent = 'Error fetching initial activity.';
            }
        }

        // Establish WebSocket connection for real-time updates
        const ws = new WebSocket(`ws://${window.location.host}/ws`);

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            updateLog(data); // Update the log with real-time data
        };

        ws.onopen = () => {
            console.log('WebSocket connection established.');
        };

        ws.onerror = (err) => {
            console.error('WebSocket error:', err);
            logContainer.textContent = 'WebSocket error. Check the console for details.';
        };

        ws.onclose = () => {
            console.warn('WebSocket connection closed.');
            logContainer.textContent = 'WebSocket connection closed.';
        };

        // Fetch initial activity on page load
        fetchActivity();
    </script>
</body>

</html>